---
title: "Problem Set 06"
subtitle: "Week 04 Day 01"
output: 
  html_document:
    toc: true
    toc_float: true
    number_section: false
    highlight: tango
    theme: "cosmo"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
```

```{r}
library(tidyverse)
```


# Learning objectives


# Exercises

2. [HTZ: 8.4-10] Because of tourism in the state, it was proposed that public schools in Michigan begin after Labor Day. To determine whether support for this change was greater than 65%, a public poll was taken. Let $p$ equal the proportion of Michigan adults who favor a post-Labor Day start.

    a. State the null and alternative hypotheses
    b. Define a test statistic and a $\alpha = 0.025$ critical region.
    c. Given that 414 out of a sample of 600 favor a post-Labor Day start, calculate the value of the test statistic.
    d. Find the p-value and state your conclusion.
    f. Use `prop.test()` in R to conduct this hypothesis test and check your work. *Note: instead of the normal approximation (which is easy to do by-hand), R uses a more complicated (but more precise) procedure that relies on the chi-square distribution. However, the p-value should still be similar to your "by-hand" work*
    
```{r}
p0 <- .65
y <- 414
n <- 600
phat <- y/n
Z <- (phat - p0)/sqrt(p0*(1-p0)/n)
pnorm(Z, lower.tail = FALSE)

se_phat <- sqrt(phat*(1-phat)/n)

phat - 1.96*se_phat

prop.test(x = 414, n = 600, alternative = "greater", 
          p = .65, correct = TRUE)
```

1. Assume you are testing the hypotheses $H_0: \mu = \mu_0$ vs. $H_A: \mu > \mu_0$ and that $\sigma$ is known. Define a critical region $C$ such that if $\overline{X} \in C$, you reject $H_0$ at a significance level of $\alpha$. That is, define an expression for a critical value that will result in a Type I error rate of $\alpha$. Or stated yet another way, your region $C$ should be defined such that $P(\overline{X} \in C |H_0 \text{ true}) = \alpha$. *Hint: Start with the following probability statement are rearrange* $$P\left(\frac{\overline{X} - \mu}{\sigma/\sqrt{n}}>z_{\alpha}\right) = \alpha$$

2. Do the same thing as in #1 (define an appropriate critical region) for the following hypothesis tests:

    a. $H_0: \mu = \mu_0$ vs. $H_A: \mu < \mu_0$, $\sigma$ known
    b. $H_0: \mu = \mu_0$ vs. $H_A: \mu \neq \mu_0$, $\sigma$ known
    c. $H_0: \mu = \mu_0$ vs. $H_A: \mu \neq \mu_0$, $\sigma$ unknown

3. [HTZ: 8.1-5] The mean birth weight in the United States is $\mu = 3315$, with a standard deviation of $\sigma = 575$. Let $X$ equal the birth weight in grams in Jerusalem. Conduct a hypothesis test to investigate whether the average birth weight in Jerusalem is lower than in the U.S.

    a. State the null and alternative hypotheses
    b. Define a critical region that has a significance level of $\alpha = 0.05$. 
    c. If the random sample of $n = 30$ yielded $\overline{X} = 3189$ and $s = 488$, what would be your conclusion?
    d. What is the p-value of your test?

4. [From PS-03]. For developing countries in Asia (excluding China) and Africa, random samples of $n_1 = 1300$ and $n_2 = 1100$ yielded $y_1 = 520$ and $y_2 = 385$ children with chronic malnutrition, respectively. Set up and conduct an appropriate hypothesis test for this data. Make sure to state the hypotheses, the $\alpha$ level, the critical region, the relevant point estimates, the test statistic, the p-value, and your conclusion. 

5. [HTZ: 8.4-10] Because of tourism in the state, it was proposed that public schools in Michigan begin after Labor Day. To determine whether support for this change was greater than 65%, a public poll was taken. Let $p$ equal the proportion of Michigan adults who favor a post-Labor Day start.

    a. State the null and alternative hypotheses
    b. Define a test statistic and a $\alpha = 0.025$ critical region.
    c. Given that 414 out of a sample of 600 favor a post-Labor Day start, calculate the value of the test statistic.
    d. Find the p-value and state your conclusion.
    e. Find a one-sided 95% confidence interval that gives a lower bound for $p$.
    f. Use `prop.test()` in R to conduct this hypothesis test and check your work. *Note: instead of the normal approximation (which is easy to do by-hand), R uses a more complicated (but more precise) procedure that relies on the chi-square distribution. However, the p-value and the confidence interval should still be similar to your "by-hand" work*

6. Use `prop.test()` to conduct the hypothesis test in #4. 

# Simulation exploration 

The `NHANES` dataset in the `NHANES` package contains data collected by the US National Center for Health Statistics (NCHS) on 10,000 individuals from 2009 - 2012. For the purposes of this exercise, we will treat this as a **population** dataset. 

Our variable of interest is `Smoke100`, which is a categorical variable for whether or not the individual has smoked 100 cigarettes in their lifetime. This question was asked only of those age 20 and older, so we will subset the data to this sub-population.

```{r}
library(NHANES)
library(infer)

adults <- NHANES %>% 
  filter(Age >= 20)
```

The proportion of US adults (in 2009 - 2012) who had smoked 100 cigarettes in their lifetime was 44.4%. That is $p = 0.44$. 

```{r}
p <- adults %>% 
  summarize(p = sum(Smoke100 == "Yes")/n()) %>% 
  pull
p
```

Note, not every random sample from this population will produce a sample statistic of $\hat{p} = 0.44$; there will be sampling variability. The following code draws 10,000 random samples of size 100 and computes $\hat{p}$ in each. 

```{r}
n <- 100
samples <- rep_sample_n(adults, n, 
                        replace = TRUE, 
                        reps = 10000)

sample_props <- samples %>% 
  group_by(replicate) %>% 
  summarize(phat = sum(Smoke100 == "Yes")/n()) 
```

7. Use the simulated values to visualize the sampling distribution of  $\hat{p}$. Describe the distribution. 

```{r, echo = FALSE, eval = FALSE}
ggplot(sample_props, aes(x = phat)) +
  geom_histogram()
```

8. Consider the hypothesis test $H_0: p = 0.44$ vs. $H_A: p \neq 0.44$ with $\alpha = 0.05$. 

    a. Is the null hypothesis true in this case? 
    b. Recall the test statistic is given by $Z = \frac{\hat{p} - p_0}{\sqrt{\frac{p_0(1-p_0)}{n}}}$, where $\hat{p}$ is the proportion observed in the sample, $p_0$ is the value of the parameter hypothesized in $H_0$, and $n$ is the sample size. What proportion of the random samples drawn from the `adults` population do you expect to result in a test statistic $|Z| > 1.96$? Why? What about $|Z| > 1.5$?
    c. What is the appropriate critical region for this test? That is, for which values of the test statistic $Z$ should $H_0$ be rejected? 
    d. Will a test statistic that falls in the critical region lead to a correct or incorrect conclusion to the hypothesis test in this case?

9. Write code that utilizes the simulated values to investigate what proportion of simulated values fall in the critical region. *Hint: create a new variable that computes the Z-statistic for each $\hat{p}$ as well as an indicator variable for whether the Z-statistic falls in the critical region.* Comment on what you find.

```{r, echo = FALSE, eval = FALSE}
alpha <- 0.05
sample_props <- sample_props %>% 
  mutate(Z = (phat - p)/sqrt(phat*(1-phat)/n),
         Z_reject = if_else((Z < qnorm(alpha/2) | Z > qnorm(1-alpha/2)), 1, 0),
         p_value = 2*pnorm(abs(Z), lower.tail = FALSE),
         p_reject = if_else(p_value < alpha, 1, 0))

sample_props %>% 
  summarize(sum(Z_reject)/n(),
            sum(p_reject)/n())
```

10. What is the critical region (on the scale of $\hat{p}$) that corresponds to $|Z| > 1.96$. Re-create the plot from #7 but add vertical lines that mark the critical region. Comment on the proportion of values that fall in the critical region.  

```{r, echo = FALSE, eval = FALSE}
ub <- qnorm(.975)*sqrt(p*(1-p)/n) + p
lb <- -qnorm(.975)*sqrt(p*(1-p)/n) + p

ggplot(sample_props, aes(x = phat)) +
  geom_histogram() +
  geom_vline(xintercept = lb, color = "blue") +
  geom_vline(xintercept = ub, color = "blue")
```

11. Still considering the hypothesis test $H_0: p = 0.44$ vs. $H_A: p \neq 0.44$ and your current set of simulations: how often do you expect to get a p-value < 0.05? Why? Will p-value < 0.05 lead to a correct or incorrect conclusion to the hypothesis test in this case? 

12. Write code that utilizes the simulated values to investigate the above question. Comment on what you find. What are the connections between what you find here and what you found in #9 - 10?

13. What type of error were #8 - #12 demonstrating? Explain. If you wanted to reduce this error, what would you do? Explain.

14. What proportion would you expect to fall in the critical region if you instead use a Z-cutoff of 2.576? Why? What would be the appropriate corresponding p-value cutoff in this case? Comment on how critical values and p-value cutoffs relate to one another. 

15. Still within the context of the `NHANES` adult population (where we happen to know the true $p = 0.44$), consider a group of researchers (who don't have the omniscience we have) who test the hypothesis $H_0: p = 0.5$ vs. $H_A: p < 0.5$. What type of error is possible in this scenario? Why? 

16. Define an appropriate critical region - in terms of $\hat{p}$ and in terms of $Z$ - for an $\alpha$ level of 0.05 for the hypothesis test in #15. That is, what should the researchers set as their cut-off values if they want to reject their null hypothesis at most 5% of the time if it is in fact true? *Hint: your work from #10 may be useful here*

```{r, echo = FALSE, eval = FALSE}
p2 <- 0.5
lb2 <- -qnorm(.95)*sqrt(p2*(1-p2)/n) + p2
```

17. Find the probability that the researchers analysis in #15 will result in a Type II error, knowing what we know about the `NHANES` population. That is, find the probability that you fail to reject $H_0: p = 0.5$ (and claim $p<0.5$) when in fact the true $p = 0.44$. Find this probability mathematically, then, use the simulated values to demonstrate/verify this probability. 

```{r, eval = FALSE, echo = FALSE}
V <- p2*(1-p2)/100
1 - pnorm(lb2, .444, sqrt(V))

V500 <- p2*(1-p2)/500
1 - pnorm(lb2, .444, sqrt(V500))

sample_props %>% 
  summarize(sum(phat > lb2)/n())
```

<!-- 19. Re-run the simulations again, this time with samples of size $n = 500$. Plot the sampling distribution of $\hat{p}$ again, adding vertical lines for the critical region determined in #11. What do you notice? Comment on what happened and why. -->

<!-- ```{r, eval = FALSE, echo = FALSE} -->
<!-- n <- 500 -->
<!-- samples2 <- rep_sample_n(adults, n,  -->
<!--                         replace = TRUE,  -->
<!--                         reps = 10000) -->

<!-- sample_props2 <- samples2 %>%  -->
<!--   group_by(replicate) %>%  -->
<!--   summarize(phat = sum(Smoke100 == "Yes")/n())  -->

<!-- ggplot(sample_props2, aes(x = phat)) + -->
<!--   geom_histogram() + -->
<!--   geom_vline(xintercept = lb, color = "blue") + -->
<!--   geom_vline(xintercept = ub, color = "blue") -->
<!-- ``` -->

<!-- 20. Determine the appropriate critical region (in terms of $\hat{p}$) for a significance level of $\alpha$ when testing $H_0: p = 0.44$ vs $H_A: p \neq 0.44$ (still assuming $n = 500$). Comment on how and why this critical region is different from the one you found in #11. What is the appropriate critical region in terms of $Z$? Comment on how and why this relates to the previous critical regions you found in terms of Z.  -->

<!-- 21. Use the simulated values (with samples of size 500) to compute the proportion that fall into the rejection region in #14. What type of error rate is this demonstrating?  -->

<!-- 22. Consider again the hypothesis test $H_0: p = 0.5$ vs. $H_A: p < 0.5$. Determine the appropriate critical region (in terms of $\hat{p}$) for a significance level of $\alpha$. Comment on how and why this is different from the critical region in #20 and #16.  -->

<!-- 23. Find the probability of a Type II error in this scenario. That is, find the probability that you fail to reject $H_0: p = 0.5$ when the true $p = 0.44$. Find this probability mathematically, then, use the simulated values to demonstrate/verify this probability.   -->

<!-- 24. Comment on how sample size relates to Type I and Type II error rates.  -->

<!-- ```{r, eval = FALSE} -->
<!-- %>%  -->
<!--   mutate(Z = (phat - p)/sqrt(phat*(1-phat)/n), -->
<!--          Z_reject = if_else((Z < qnorm(alpha/2) | Z > qnorm(1-alpha/2)), 1, 0), -->
<!--          p_value = 2*pnorm(abs(Z), lower.tail = FALSE), -->
<!--          p_reject = if_else(p_value < alpha, 1, 0)) -->

<!-- sample_props %>%  -->
<!--   summarize(sum(Z_reject)/n(), -->
<!--             sum(p_reject)/n()) -->
<!-- ggplot(sample_props, aes(x = phat)) + -->
<!--   geom_histogram() -->

<!-- ggplot(sample_props, aes(x = Z)) + -->
<!--   geom_histogram() -->

<!-- ggplot(sample_props, aes(x = p_value)) + -->
<!--   geom_histogram(binwidth = 0.05) -->

<!-- sample_props %>%  -->
<!--   summarize(sum(phat < 0.33)/n()) -->
<!-- ``` -->




## Submission

Once you have completed all Exercises and written up your results in the Template .Rmd provided, take about 5-10 minutes to respond to the reflection prompts (RP) at the top of the Template:

+ (RP1): *What were the main concepts covered in this assignment?*

+ (RP2): *What's one thing you understand better after completing these problems?*

+ (RP3): *What problems gave you the most trouble? What was difficult about them/where did you get stuck?*

Knit your document one final time, then upload your .html file to Problem Set 05 on Canvas. 

## Grading (50pts)

| Component | Points |
|:----------|:-------|
| RP1      | 5      |
| RP2      | 5    |
| RP3      | 5    |
| Formatting & Clarity | 5 |
| Exercise completion | 30 |